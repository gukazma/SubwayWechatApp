name: Deploy to Production

on:
  push:
    branches:
      - main  # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
      - master  # ä¹Ÿæ”¯æŒ master åˆ†æ”¯
    paths:
      - 'server/**'  # åªæœ‰ server ç›®å½•å˜åŒ–æ—¶æ‰è§¦å‘
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    environment:
      name: production
      url: ${{ secrets.SERVER_HOST }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./server
        run: npm ci --production

      - name: âœ… Run tests
        working-directory: ./server
        run: npm test || echo "âš ï¸  No tests found, skipping..."

      - name: ğŸš€ Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            echo "ğŸš€ Starting deployment..."

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /var/www/subway-server || exit 1

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main || git pull origin master

            # è¿›å…¥ server ç›®å½•
            cd server

            # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼‰
            echo "ğŸ’¾ Creating backup..."
            timestamp=$(date +%Y%m%d_%H%M%S)
            mkdir -p ../backups
            tar -czf ../backups/backup_${timestamp}.tar.gz . || echo "âš ï¸  Backup failed"

            # å¤åˆ¶ç¯å¢ƒé…ç½®
            if [ ! -f .env.production ]; then
              echo "âš ï¸  .env.production not found! Please create it manually."
            fi

            # å®‰è£…ä¾èµ–
            echo "ğŸ“¦ Installing dependencies..."
            npm install --production

            # é‡å¯æœåŠ¡
            echo "ğŸ”„ Restarting service..."
            if command -v pm2 &> /dev/null; then
              pm2 restart subway-wechat-server || pm2 start ecosystem.config.js --env production
              pm2 save
              echo "âœ… Service restarted with PM2"
            else
              echo "âŒ PM2 not found! Please install PM2 first."
              exit 1
            fi

            # æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™æœ€è¿‘5ä¸ªï¼‰
            echo "ğŸ§¹ Cleaning old backups..."
            cd ../backups
            ls -t | tail -n +6 | xargs -r rm --

            echo "âœ… Deployment completed successfully!"

      - name: ğŸ” Health check
        if: success()
        run: |
          echo "â³ Waiting 10 seconds for service to start..."
          sleep 10

          echo "ğŸ” Checking service health..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:3000/api/test || echo "000")

          if [ "$response" = "200" ]; then
            echo "âœ… Health check passed! Service is running."
          else
            echo "âš ï¸  Health check returned status code: $response"
            echo "Please check the service manually."
          fi

      - name: ğŸ“¢ Notification
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸ‰ âœ… Deployment successful!"
            echo "ğŸŒ Server: ${{ secrets.SERVER_HOST }}"
            echo "ğŸ“… Time: $(date)"
          else
            echo "âŒ Deployment failed!"
            echo "Please check the logs above for details."
          fi
